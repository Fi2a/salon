<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/default}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/master/shopEdit.css}">
    </th:block>
</head>

<body>
<div layout:fragment="main" id="main">
    <div class="section-container">
        <h3>매장 정보 수정</h3>
        <div class="customer-card">
            <form  th:object="${shop}">
                <input type="hidden" th:field="*{id}" />


                <div class="customer-header">
                    <strong>매장명</strong>
                    <input type="text" th:field="*{name}" placeholder="매장 이름을 입력하세요" required />
                </div>

                <div class="customer-header">
                    <strong>연락처</strong>
                    <input type="text" th:field="*{tel}" placeholder="전화번호 입력" />
                </div>

                <div class="customer-header">
                    <strong>주소</strong>
                    <div class="address-wrapper">
                        <div class="address-row">
                            <input type="text" id="postcode" placeholder="우편번호" readonly />
                            <button type="button" class="btn-search-address" onclick="execDaumPostcode()">우편번호 찾기</button>
                        </div>

                        <input type="text" id="roadAddress" placeholder="도로명주소" th:value="*{address}" readonly />

                        <div class="address-row">
                            <input type="text" id="detailAddress" th:field="*{addressDetail}" placeholder="상세주소 입력" />
                            <input type="text" id="extraAddress" placeholder="참고항목" readonly />
                        </div>

                        <input type="hidden" th:field="*{latitude}" />
                        <input type="hidden" th:field="*{longitude}" />
                        <input type="hidden" th:field="*{address}" id="fullAddress" />
                    </div>
                </div>

                <div id="addressModal" class="modal">
                    <div class="modal-content">
                        <div id="daumWrap" style="width:100%;height:100%;"></div>
                    </div>
                </div>

                <div class="customer-header">
                    <strong>운영시간</strong>
                    <input type="time" name="openTime" id="openTime" th:value="${#temporals.format(shop.openTime, 'HH:mm')}" />
                    <input type="time" name="closeTime" id="closeTime" th:value="${#temporals.format(shop.closeTime, 'HH:mm')}" />
                </div>

                <div class="customer-header">
                    <strong>지각 기준 (분)</strong>
                    <input type="number" th:field="*{lateMin}" min="0" />
                </div>

                <div class="customer-header">
                    <strong>조퇴 기준 (분)</strong>
                    <input type="number" th:field="*{earlyLeaveMin}" min="0" />
                </div>

                <div class="customer-header">
                    <strong>예약 간격 (분)</strong>
                    <input type="number" th:field="*{reservationInterval}" min="10" step="5" />
                </div>

                <div class="customer-header">
                    <strong>마감 전 예약 제한시간 (분)</strong>
                    <input type="number" th:field="*{timeBeforeClosing}" min="0" />
                </div>

                <div class="customer-header">
                    <strong>휴무 요일</strong>
                    <select th:field="*{dayOff}">
                        <option value="0">없음</option>
                        <option value="1">월요일</option>
                        <option value="2">화요일</option>
                        <option value="4">수요일</option>
                        <option value="8">목요일</option>
                        <option value="16">금요일</option>
                        <option value="32">토요일</option>
                        <option value="64">일요일</option>
                    </select>
                    <span style="font-size: 13px; color: #999;">※ 이진법으로 계산됩니다.</span>
                </div>

                <div class="customer-header">
                    <strong>매장 소개</strong>
                    <textarea th:field="*{description}" placeholder="매장 설명 입력"></textarea>
                </div>
            </form>
            <form id="shop-edit-form"  enctype="multipart/form-data" >
                <div class="customer-header">
                    <strong>사진 업로드</strong>
                    <div class="shop-image-upload">
                        <!-- 업로드 버튼 -->
                        <input type="file" id="shopImageInput" name="files" multiple accept="image/*" />
                        <label for="shopImageInput" class="custom-upload-label">📷 사진 업로드</label>

                        <!-- 이미지 미리보기 영역 -->
                        <div id="shopImagePreview" class="image-preview-container">
                            <th:block th:each="image, iterStat : ${shop.shopImages}">
                                <div class="preview-image-wrapper" th:data-id="${image.id}">
                                    <img th:src="@{${image.imgUrl}}" class="preview-image" th:alt="${image.originalName}" />

                                    <!-- 썸네일 선택용 라디오 -->
                                    <input type="radio"
                                           name="thumbnailImageId"
                                           class="thumbnail-radio"
                                           th:value="${image.id}"
                                           th:checked="${image.isThumbnail} ? 'checked' : null" />

                                    <!-- 삭제 버튼 -->
                                    <button type="button" class="btn-delete-img" th:data-id="${image.id}">×</button>

                                </div>
                            </th:block>
                        </div>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button type="button" class="btn-edit" onclick="submitShopEdit()">저장하기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0bcfa737cae58afd2f78fe737895ea3b&autoload=false&libraries=services"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script>

        let selectedFiles = []; // 새로 선택한 파일들
        let deletedImageIds = []; // 기존 이미지 삭제 id 모음

        // 기존 이미지 삭제 시 호출
        function deleteExistingImage(id) {
          console.log('삭제 요청 id:', id);
          const imageDiv = document.querySelector(`.preview-image-wrapper[data-id="${id}"]`);
          if (imageDiv) {
            imageDiv.remove();
            deletedImageIds.push(Number(id)); // id가 문자열이면 숫자 변환 권장
            console.log('삭제된 이미지 ID 목록:', deletedImageIds);
          } else {
            console.warn('삭제할 이미지 요소를 찾지 못했습니다:', id);
          }
        }

        // 새 이미지 선택 시 미리보기 추가
        document.getElementById('shopImageInput').addEventListener('change', function () {
            const preview = document.getElementById('shopImagePreview');
            const newFiles = Array.from(this.files);

            newFiles.forEach(file => {
                // 중복 체크
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) return;

                selectedFiles.push(file);

                const reader = new FileReader();
                reader.onload = function (e) {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('preview-image-wrapper');

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('preview-image');

                    // 새 이미지는 id가 없으니 data-id 안 붙임

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerText = '×';
                    deleteBtn.classList.add('btn-delete-img');
                    // 새 이미지 삭제 시 selectedFiles에서 제거
                    deleteBtn.addEventListener('click', () => {
                        wrapper.remove();
                        selectedFiles = selectedFiles.filter(f => f !== file);
                    });

                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteBtn);
                    preview.appendChild(wrapper);
                };
                reader.readAsDataURL(file);
            });

            this.value = ''; // 같은 파일 다시 선택 가능하게 초기화
        });

        // 이벤트 위임으로 삭제 버튼 처리 (기존 이미지 및 새 이미지 삭제)
        document.getElementById('shopImagePreview').addEventListener('click', e => {
          if (e.target.classList.contains('btn-delete-img')) {
            // 기존 이미지 삭제용 data-id가 있으면 그걸 사용
            const id = e.target.getAttribute('data-id');
            if (id) {
              deleteExistingImage(id);
            } else {
              // 새 이미지 삭제: 버튼이 있는 div를 찾아서 제거
              const wrapper = e.target.closest('.preview-image-wrapper');
              if (wrapper) {
                wrapper.remove();
                // 새 이미지 삭제 시 selectedFiles 갱신 필요
                // 삭제된 파일 찾기 위해 wrapper 내부 img src로 비교 가능하나 복잡하면 생략 가능
                // 또는 selectedFiles 초기화 후 다시 선택하도록 안내
              }
            }
          }
        });

        // 저장 함수
        function submitShopEdit() {
            const formData = new FormData();

            // shop 정보 수집 (id, name 등)
            const shopData = {
                id: document.querySelector('input[name="id"]').value,
                name: document.querySelector('input[name="name"]').value,
                tel: document.querySelector('input[name="tel"]').value,
                address: document.querySelector('#roadAddress').value,
                addressDetail: document.querySelector('#detailAddress').value,
                latitude: document.querySelector('input[name="latitude"]').value,
                longitude: document.querySelector('input[name="longitude"]').value,
                openTime: document.querySelector('#openTime').value,
                closeTime: document.querySelector('#closeTime').value,
                lateMin: parseInt(document.querySelector('input[name="lateMin"]').value, 10),
                earlyLeaveMin: parseInt(document.querySelector('input[name="earlyLeaveMin"]').value, 10),
                reservationInterval: parseInt(document.querySelector('input[name="reservationInterval"]').value, 10),
                timeBeforeClosing: parseInt(document.querySelector('input[name="timeBeforeClosing"]').value, 10),
                dayOff: parseInt(document.querySelector('select[name="dayOff"]').value, 10),
                description: document.querySelector('textarea[name="description"]').value
            };

            formData.append('shopEditDto', JSON.stringify(shopData));

            // 새 이미지들 formData에 추가
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            // 썸네일 이미지 id는 지금 사용 안 하니 빈값 전송 가능
            formData.append('thumbnailImageId', '');

            // 삭제할 기존 이미지 ID 배열을 JSON 문자열로 전송
            formData.append('deletedImageIds', JSON.stringify(deletedImageIds));

            fetch('/master/shop-edit/update', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    alert('저장 성공!');
                    location.href = '/master';
                } else {
                    alert('저장 실패');
                }
            }).catch(error => {
                console.error('전송 오류:', error);
            });
        }

    </script>

</th:block>

</body>
</html>